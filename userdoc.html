<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Overview &mdash; aodncore 1.4.5 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Overview" href="developerdoc.html" />
    <link rel="prev" title="Writing a dest_path() function" href="quickstartdoc.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> aodncore
          </a>
              <div class="version">
                1.4
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Quick Start Guide:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="quickstartdoc.html">Writing a <code class="xref py py-meth docutils literal notranslate"><span class="pre">dest_path()</span></code> function</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstartdoc.html#overriding-default-file-actions">Overriding default file actions</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstartdoc.html#creating-products-during-the-handler-lifetime">Creating products during the handler lifetime</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstartdoc.html#query-storage">Query Storage</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User documentation:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="#state-machine-handler-steps">State machine / handler steps</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#initialise">initialise</a></li>
<li class="toctree-l2"><a class="reference internal" href="#resolve">resolve</a></li>
<li class="toctree-l2"><a class="reference internal" href="#preprocess">preprocess</a></li>
<li class="toctree-l2"><a class="reference internal" href="#check">check</a></li>
<li class="toctree-l2"><a class="reference internal" href="#process">process</a></li>
<li class="toctree-l2"><a class="reference internal" href="#publish">publish</a></li>
<li class="toctree-l2"><a class="reference internal" href="#postprocess">postprocess</a></li>
<li class="toctree-l2"><a class="reference internal" href="#notify">notify</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#customising-handler-behaviour">Customising handler behaviour</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#methods">Methods</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#attributes">Attributes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#class-parameters">Class parameters</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="developerdoc.html">Overview</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Module contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="modules.html">aodncore</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">aodncore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Overview</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/userdoc.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this heading"></a></h1>
<p>The <code class="docutils literal notranslate"><span class="pre">aodncore.pipeline</span></code> package provides the base class for each pipeline handler,
<a class="reference internal" href="aodncore.pipeline.html#aodncore.pipeline.HandlerBase" title="aodncore.pipeline.HandlerBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">aodncore.pipeline.HandlerBase</span></code></a>. This is the starting point for any new handler development, as
it contains all of the core functionality of each handler, which is then available to the child class via class
inheritance.</p>
</section>
<section id="state-machine-handler-steps">
<h1>State machine / handler steps<a class="headerlink" href="#state-machine-handler-steps" title="Permalink to this heading"></a></h1>
<p>In order to provide consistency and structure to the handler, the pipeline is broken into a series of ordered “steps”,
with each performing a distinct function in the processing of the input file. The “machine” defines a series of states,
and also controls/enforces the transitions between states.</p>
<p>For example, since it makes no sense to check a collection of files before the collection exists, the state machine
enforces that the <code class="docutils literal notranslate"><span class="pre">check</span></code> step may <em>only</em> be entered into from the <code class="docutils literal notranslate"><span class="pre">resolve</span></code> step.</p>
<p>Similarly, the <code class="docutils literal notranslate"><span class="pre">publish</span></code> step cannot ever be entered into other than from the <code class="docutils literal notranslate"><span class="pre">process</span></code> step, which means that the
step can safely make several assumptions about the overall state of the handler when it does get executed. For example,
it can automatically assume with a 100% guarantee that the <code class="docutils literal notranslate"><span class="pre">initalise</span></code>, <code class="docutils literal notranslate"><span class="pre">resolve</span></code>, <code class="docutils literal notranslate"><span class="pre">preprocess</span></code>, <code class="docutils literal notranslate"><span class="pre">check</span></code> and
<code class="docutils literal notranslate"><span class="pre">process</span></code> step have all been run in that order with no errors, allowing it to focus purely on the core concern of the
step; publishing files, and nothing more.</p>
<p>The ordered steps are as follows:</p>
<section id="initialise">
<h2>initialise<a class="headerlink" href="#initialise" title="Permalink to this heading"></a></h2>
<p>Responsible for general setup of handler class and performing initial sanity checking of the input file and parameters</p>
<ol class="arabic simple">
<li><p>validation of parameters</p></li>
<li><p>validation of input file (e.g. the file exists, is accessible, is of an allowed type etc.)</p></li>
<li><p>setup temporary directories</p></li>
</ol>
</section>
<section id="resolve">
<h2>resolve<a class="headerlink" href="#resolve" title="Permalink to this heading"></a></h2>
<p>Responsible for preparing the central file collection of the handler instance, including handling input files which
represent multiple files (e.g. ZIP and manifest files). The file collection is used to hold the processing state of all
“known” files for the duration of the handler. After this step, there is no need to consider the original source format
of the input file, as this step “resolves” the file into a generic collection for further processing.</p>
<ol class="arabic">
<li><p>prepare the “file collection” used by all subsequent steps by placing files into a temporary directory and
creating an entry in the handlers “file_collection” attribute, which is a special type of set
(PipelineFileCollection object) optimised for dealing with pipeline files (PipelineFile objects)</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>if single file, copy to temporary directory and add to file collection</p></li>
<li><p>if ZIP file, extract files into temporary directory and add them to the file collection</p></li>
<li><p>if manifest file, add files “in place” to the file collection</p></li>
</ol>
</div></blockquote>
</li>
<li><p>update files to be included/excluded from processing based on regex filter (if defined in parameter)</p></li>
</ol>
</section>
<section id="preprocess">
<h2>preprocess<a class="headerlink" href="#preprocess" title="Permalink to this heading"></a></h2>
<p>Special override method (see below for details)</p>
</section>
<section id="check">
<h2>check<a class="headerlink" href="#check" title="Permalink to this heading"></a></h2>
<p>Responsible for checking the validity and/or compliance of files in the collection.</p>
<ol class="arabic simple">
<li><p>determine the type of check to be performed based on the handler parameters and file type</p>
<ol class="arabic simple">
<li><p>if NetCDF and compliance checks defined in parameters, check against listed check suites</p></li>
<li><p>if NetCDF and no compliance checks defined, validate NetCDF format</p></li>
<li><p>if known file type, validate file format (e.g. if .pdf extension, validate PDF format)  # TODO</p></li>
<li><p>if unknown file type, check that the file is not empty</p></li>
</ol>
</li>
</ol>
</section>
<section id="process">
<h2>process<a class="headerlink" href="#process" title="Permalink to this heading"></a></h2>
<p>Special override method (see below for details)</p>
</section>
<section id="publish">
<h2>publish<a class="headerlink" href="#publish" title="Permalink to this heading"></a></h2>
<p>Responsible for publishing the file to external repositories. This is a composite step, and will perform the following
actions only on files in the collection which have been flagged for that action (as determined by the publish_type
attribute of the files).</p>
<ol class="arabic simple">
<li><p>determine files flagged as needing to be archived, and upload to ‘archive’ location</p></li>
<li><p>determine files flagged as needing to be harvested, match and execute Talend (or CSV) harvester(s) for files</p></li>
<li><p>determine files flagged as needing to be uploaded or deleted, and perform the necessary storage operation</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>upload/delete operations are collectively referred to in the handler and supporting code as “store” operations</p>
</div>
</section>
<section id="postprocess">
<h2>postprocess<a class="headerlink" href="#postprocess" title="Permalink to this heading"></a></h2>
<p>Special override method (see below for details)</p>
</section>
<section id="notify">
<h2>notify<a class="headerlink" href="#notify" title="Permalink to this heading"></a></h2>
<p>Responsible for notifying the uploader and/or the pipeline ‘owner’ of the result of the handler attempt.</p>
<ol class="arabic simple">
<li><p>determine the recipients, based on notification parameters and handler result</p></li>
<li><p>send notifications</p></li>
</ol>
</section>
</section>
<section id="customising-handler-behaviour">
<h1>Customising handler behaviour<a class="headerlink" href="#customising-handler-behaviour" title="Permalink to this heading"></a></h1>
<section id="methods">
<h2>Methods<a class="headerlink" href="#methods" title="Permalink to this heading"></a></h2>
<p>The methods in the HandlerBase (and therefore any subclasses inheriting from it) can be separated into two categories:</p>
<p><em>Internal / non-public methods</em></p>
<p>These methods must <em>not</em> be overridden by child handlers, or the handler behaviour will be compromised. In following the
Python convention, these methods begin with a single underscore (_) character. Note that this is a convention, and
therefore it is possible to manipulate or even override them, however it is mandatory that the conventions are followed
to maintain the integrity of the handler execution.</p>
<p>In addition to any methods starting with one or more underscores, the <code class="docutils literal notranslate"><span class="pre">run</span></code> method is also a special case, which must
<em>not</em> be overridden or extended, as this is the entry point for handler execution. This is implemented and run
separately from the class initialiser (<code class="docutils literal notranslate"><span class="pre">`__init__`</span></code>) such that the handler instance can be created, and have it’s
contents inspected (e.g. by unit tests) before and after actually executing the file processing code of the handler.</p>
<p><em>Public methods</em></p>
<p>There are three special methods defined which are <em>intended</em> to be overridden by subclasses in order to provide a
handler author with the ability to call code in order to modify the behaviour of the handler during it’s execution.</p>
<p>The special methods are: <code class="docutils literal notranslate"><span class="pre">preprocess</span></code>, <code class="docutils literal notranslate"><span class="pre">process</span></code> and <code class="docutils literal notranslate"><span class="pre">postprocess</span></code></p>
<p>These methods are deliberately left empty (i.e. they are there but don’t do anything) in the base class, so it is purely
optional whether the subclass implements these.</p>
<p>The only difference between these methods is <em>when</em> they are called by the handler state machine. Refer to the above
section for further details about where they appear in the steps order.</p>
</section>
</section>
<section id="attributes">
<h1>Attributes<a class="headerlink" href="#attributes" title="Permalink to this heading"></a></h1>
<p>A handler instance contains a number of attributes which control or modify the behaviour of the handler. The attributes
are typically set from the <strong>params</strong> key of the watch configuration, or from the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method of a handler
subclass (e.g. when writing tests).</p>
<section id="class-parameters">
<h2>Class parameters<a class="headerlink" href="#class-parameters" title="Permalink to this heading"></a></h2>
<p>The following class parameters are also assigned to attributes of the same name, as a convenience.</p>
<p>For example, a handler instantiated with any of these class parameters may also access them from the class instance as
follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">aodncore.pipeline</span> <span class="kn">import</span> <span class="n">HandlerBase</span>
<span class="kn">from</span> <span class="nn">aodncore.pipeline.config</span> <span class="kn">import</span> <span class="n">CONFIG</span>


<span class="k">class</span> <span class="nc">MyHandler</span><span class="p">(</span><span class="n">HandlerBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">print_upload_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Note: when accessing attributes from within the class itself, the usual Python &#39;self.attr&#39;</span>
        <span class="c1"># convention applies to access the *current* instance</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upload_path</span><span class="p">)</span>


<span class="n">h</span> <span class="o">=</span> <span class="n">MyHandler</span><span class="p">(</span><span class="s1">&#39;/path/to/input/file.nc&#39;</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">,</span> <span class="n">upload_path</span><span class="o">=</span><span class="s1">&#39;/original/incoming/path/file.nc&#39;</span><span class="p">)</span>
<span class="n">h</span><span class="o">.</span><span class="n">input_file</span>
<span class="s1">&#39;/path/to/input/file.nc&#39;</span>
<span class="n">h</span><span class="o">.</span><span class="n">upload_path</span>
<span class="s1">&#39;/original/incoming/path/file.nc&#39;</span>
<span class="n">h</span><span class="o">.</span><span class="n">config</span>
<span class="o">&lt;</span><span class="n">aodncore</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">configlib</span><span class="o">.</span><span class="n">LazyConfigManager</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x7f22230c5990</span><span class="o">&gt;</span>

<span class="n">h</span><span class="o">.</span><span class="n">print_upload_path</span><span class="p">()</span>
<span class="o">/</span><span class="n">original</span><span class="o">/</span><span class="n">incoming</span><span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">file</span><span class="o">.</span><span class="n">nc</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="quickstartdoc.html" class="btn btn-neutral float-left" title="Writing a dest_path() function" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="developerdoc.html" class="btn btn-neutral float-right" title="Overview" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, AODN.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>